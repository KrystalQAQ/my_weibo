# 完整的 Nginx 配置文件（包含 http 块）
# 如果你的 Nginx 使用 conf.d 目录，只需要 server 块部分

# ==================== HTTP 块配置 ====================
# 注意：如果使用 Docker 官方 Nginx 镜像，这部分应该放在 /etc/nginx/nginx.conf
# 或者创建一个单独的配置文件包含限流配置

# 限流配置（需要在 http 块中）
# 如果使用 conf.d，需要在主 nginx.conf 中添加这些行
# limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
# limit_req_zone $binary_remote_addr zone=img_limit:10m rate=20r/s;

# ==================== SERVER 块配置 ====================
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # DNS 解析器（用于图片代理）
    resolver 8.8.8.8 1.1.1.1 valid=300s;
    resolver_timeout 5s;

    # ==================== 微博 API 反向代理 ====================
    # 替代 Cloudflare Worker 的 /api/* 路由
    # 示例: /api/container/getIndex?type=uid&value=6052726496
    location /api/ {
        # 代理到微博 API
        proxy_pass https://m.weibo.cn/api/;

        # 设置请求头（模拟浏览器）
        proxy_set_header Host m.weibo.cn;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Referer "https://m.weibo.cn/";
        proxy_set_header Accept "application/json, text/plain, */*";
        proxy_set_header Accept-Language "zh-CN,zh;q=0.9,en;q=0.8";

        # 隐藏原始请求头
        proxy_set_header X-Real-IP "";
        proxy_set_header X-Forwarded-For "";

        # CORS 头（允许跨域）
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
        add_header Access-Control-Max-Age "86400" always;

        # 处理 OPTIONS 预检请求
        if ($request_method = OPTIONS) {
            return 204;
        }

        # 代理配置
        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
        proxy_redirect off;
        proxy_buffering off;

        # 超时设置
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        # 限流（如果在 http 块中配置了 limit_req_zone）
        # limit_req zone=api_limit burst=20 nodelay;
    }

    # ==================== 微博图片防盗链代理 ====================
    # 替代 Cloudflare Worker 的 /image 路由
    # 示例: /image?url=https://wx1.sinaimg.cn/large/xxx.jpg
    location ~ ^/(image|img)$ {
        # 设置变量
        set $image_url $arg_url;

        # 验证参数
        if ($image_url = "") {
            add_header Content-Type application/json always;
            return 400 '{"error":"Missing image URL parameter"}';
        }

        # 代理到图片 URL
        proxy_pass $image_url;

        # 设置请求头（绕过防盗链）
        proxy_set_header Host "";
        proxy_set_header Referer "https://weibo.com/";
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";

        # CORS 头
        add_header Access-Control-Allow-Origin "*" always;

        # 缓存设置（图片缓存 1 年）
        add_header Cache-Control "public, max-age=31536000, immutable" always;

        # 隐藏上游服务器信息
        proxy_hide_header X-Powered-By;
        proxy_hide_header Server;

        # 代理配置
        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
        proxy_redirect off;
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;

        # 超时设置
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        # 错误处理
        proxy_intercept_errors on;
        error_page 403 404 = @image_error;

        # 限流（如果在 http 块中配置了 limit_req_zone）
        # limit_req zone=img_limit burst=50 nodelay;
    }

    # 图片代理错误处理
    location @image_error {
        add_header Content-Type application/json always;
        return 404 '{"error":"Failed to fetch image","message":"Image not found or access denied"}';
    }

    # ==================== 服务信息端点 ====================
    # 替代 Cloudflare Worker 的根路径说明
    location = /proxy-info {
        add_header Content-Type application/json always;
        add_header Access-Control-Allow-Origin "*" always;
        return 200 '{
  "name": "Weibo Proxy Service (Nginx)",
  "version": "1.0.0",
  "server": "nginx",
  "endpoints": {
    "api": {
      "path": "/api/*",
      "description": "Proxy for Weibo API",
      "example": "/api/container/getIndex?type=uid&value=6052726496&containerid=1005056052726496"
    },
    "image": {
      "path": "/image?url=<image_url>",
      "description": "Proxy for Weibo images (bypass referer check)",
      "example": "/image?url=https://wx1.sinaimg.cn/large/xxx.jpg"
    }
  }
}';
    }

    # ==================== Vue 应用配置 ====================
    # Gzip 压缩配置
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/x-javascript
        application/xml
        application/xml+rss
        application/xhtml+xml
        application/x-font-ttf
        application/x-font-opentype
        application/vnd.ms-fontobject
        image/svg+xml;

    # 支持 Vue Router History 模式
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 静态资源缓存策略
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|otf|webp)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # HTML 文件不缓存
    location ~* \.html$ {
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # 安全头配置
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 禁止访问备份文件
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 自定义错误页面
    error_page 404 /index.html;
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }

    # 日志配置
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;
}
